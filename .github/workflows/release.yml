name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r tools/requirements.txt
          pip install pytest pytest-cov
      
      - name: Run tests
        run: |
          python -m pytest tests/ -v --cov=tools --cov-report=term-missing
      
      - name: Validate version tag format
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          if ! [[ "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "Error: Tag '$TAG_NAME' does not match version format vX.Y.Z[-suffix]"
            exit 1
          fi
          echo "Version tag: $TAG_NAME"
      
      - name: Check CHANGELOG.md updated
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG_NAME#v}"
          if ! grep -q "## \[$VERSION\]" CHANGELOG.md; then
            echo "Warning: CHANGELOG.md does not contain section for version $VERSION"
            echo "Please update CHANGELOG.md before releasing"
            exit 1
          fi

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Get version from tag
        id: get_version
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG_NAME#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
      
      - name: Extract changelog for version
        id: changelog
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          
          # Extract the changelog section for this version
          awk -v ver="$VERSION" '
            /^## \[/ {
              if (found) exit;
              if ($0 ~ "\\[" ver "\\]") {
                found=1;
                next;
              }
            }
            found && /^## \[/ { exit }
            found { print }
          ' CHANGELOG.md > release_notes.md
          
          # Check if we extracted any content
          if [ ! -s release_notes.md ]; then
            echo "## Release $VERSION" > release_notes.md
            echo "" >> release_notes.md
            echo "See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details." >> release_notes.md
          fi
          
          cat release_notes.md
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2.4.2
        with:
          name: Release ${{ steps.get_version.outputs.tag }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.version, '-') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'
      
      - name: Build distribution package
        run: |
          python -m pip install --upgrade pip setuptools wheel
          
          # Create a simple setup.py for distribution
          cat > setup.py << 'EOF'
          from setuptools import setup, find_packages
          
          with open("README.md", "r", encoding="utf-8") as fh:
              long_description = fh.read()
          
          with open("tools/requirements.txt", "r", encoding="utf-8") as fh:
              requirements = [line.strip() for line in fh if line.strip() and not line.startswith("#")]
          
          setup(
              name="apple-health-segments",
              version="${{ steps.get_version.outputs.version }}",
              author="Nicolas Reyrolle",
              author_email="405928+NicolasReyrolle@users.noreply.github.com",
              description="Find your fastest running segments from Apple Health exports",
              long_description=long_description,
              long_description_content_type="text/markdown",
              url="https://github.com/NicolasReyrolle/applehealth",
              packages=find_packages(),
              classifiers=[
                  "Development Status :: 4 - Beta",
                  "Intended Audience :: End Users/Desktop",
                  "Topic :: Utilities",
                  "Programming Language :: Python :: 3",
                  "Programming Language :: Python :: 3.8",
                  "Programming Language :: Python :: 3.9",
                  "Programming Language :: Python :: 3.10",
                  "Programming Language :: Python :: 3.11",
                  "Programming Language :: Python :: 3.12",
              ],
              python_requires=">=3.8",
              install_requires=requirements,
              entry_points={
                  "console_scripts": [
                      "apple-health-segments=tools.apple_health_segments:main",
                      "points-on-date=tools.points_on_date:main",
                      "compute-speed-stats=tools.compute_speed_stats:main",
                  ],
              },
          )
          EOF
          
          python setup.py sdist bdist_wheel
      
      - name: Upload release artifacts
        uses: softprops/action-gh-release@v2.4.2
        with:
          files: |
            dist/*.tar.gz
            dist/*.whl
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Post-release summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.get_version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release URL:** https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts Created" >> $GITHUB_STEP_SUMMARY
          echo "- Source distribution (.tar.gz)" >> $GITHUB_STEP_SUMMARY
          echo "- Wheel distribution (.whl)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "pip install https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.tag }}/apple-health-segments-${{ steps.get_version.outputs.version }}-py3-none-any.whl" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
